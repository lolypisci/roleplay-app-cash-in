<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teacher View - Roleplay Archive</title>
</head>
<body>

<h1>Saved Sessions</h1>

<label for="filter-student">Filter by Student:</label>
<select id="filter-student">
  <option value="all">All</option>
</select>

<table border="1" id="roleplays-table" style="margin-top: 10px;">
  <thead>
    <tr>
      <th>Buyer</th>
      <th>Seller</th>
      <th>Purchased Items</th>
      <th>Total Cost</th>
      <th>Audio</th>
      <th>Timestamp</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<script>
let allRoleplays = [];

function populateFilterOptions(roleplays) {
  const select = document.getElementById('filter-student');
  const studentsSet = new Set();

  roleplays.forEach(r => {
    studentsSet.add(r.comprador);
    studentsSet.add(r.vendedor);
  });

  // Clear options except "All"
  while (select.options.length > 1) {
    select.remove(1);
  }

  studentsSet.forEach(student => {
    const option = document.createElement('option');
    option.value = student;
    option.textContent = student;
    select.appendChild(option);
  });
}

function renderTable(filteredRoleplays) {
  const tbody = document.querySelector("#roleplays-table tbody");
  tbody.innerHTML = "";

  filteredRoleplays.forEach(r => {
    const totalCost = r.costes.reduce((a, b) => a + b, 0).toFixed(2);
    const productosHTML = r.productos.join(", ");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.comprador}</td>
      <td>${r.vendedor}</td>
      <td>${productosHTML}</td>
      <td>â‚¬${totalCost}</td>
      <td><audio controls src="${r.audio_url}"></audio></td>
      <td>${new Date(r.timestamp).toLocaleString()}</td>
    `;
    tbody.appendChild(tr);
  });
}

function loadRoleplays() {
  fetch('/roleplays')
    .then(response => response.json())
    .then(data => {
      allRoleplays = data;
      populateFilterOptions(allRoleplays);
      renderTable(allRoleplays);
    });
}

document.getElementById('filter-student').addEventListener('change', (e) => {
  const selected = e.target.value;
  if (selected === 'all') {
    renderTable(allRoleplays);
  } else {
    const filtered = allRoleplays.filter(r => r.comprador === selected || r.vendedor === selected);
    renderTable(filtered);
  }
});

// Load the table on page load
window.onload = loadRoleplays;
</script>

</body>
</html>
