<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teacher View - Roleplay Archive</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #f9f9f9;
    color: #333;
  }
  h1, h2 {
    color: #2c3e50;
  }
  label, select, button {
    font-size: 1rem;
    margin-top: 10px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 10px;
    background-color: white;
    box-shadow: 0 0 5px #ccc;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }
  th {
    background-color: #2980b9;
    color: white;
  }
  audio {
    width: 150px;
  }
  button {
    cursor: pointer;
    padding: 6px 12px;
    margin-top: 10px;
    background-color: #2980b9;
    color: white;
    border: none;
    border-radius: 3px;
  }
  button:hover {
    background-color: #1f6391;
  }
  .section {
    margin-top: 30px;
  }
</style>
</head>
<body>

<h1>Saved Sessions</h1>

<label for="filter-student">Filter by Student:</label>
<select id="filter-student">
  <option value="all">All</option>
</select>
<button id="refresh-roleplays">Refresh Sessions</button>

<table border="1" id="roleplays-table" style="margin-top: 10px;">
  <thead>
    <tr>
      <th>Buyer</th>
      <th>Seller</th>
      <th>Purchased Items</th>
      <th>Total Cost</th>
      <th>Audio</th>
      <th>Timestamp</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<div class="section">
  <h2>Record a New Roleplay</h2>
  <form id="roleplay-form">
    <label for="comprador">Buyer Name:</label><br/>
    <input type="text" id="comprador" name="comprador" required/><br/>
    <label for="vendedor">Seller Name:</label><br/>
    <input type="text" id="vendedor" name="vendedor" required/><br/>
    <label for="productos">Products (comma separated):</label><br/>
    <input type="text" id="productos" name="productos" required/><br/>
    <label for="costes">Costs (comma separated):</label><br/>
    <input type="text" id="costes" name="costes" required/><br/>
    <label for="audio">Audio File:</label><br/>
    <input type="file" id="audio" name="audio" accept="audio/*" required/><br/>
    <button type="submit">Submit Roleplay</button>
  </form>
</div>

<div class="section">
  <h2>Uploads History</h2>
  <button id="refresh-uploads">Refresh Uploads</button>
  <ul id="uploads-list"></ul>
</div>

<script>
let allRoleplays = [];

function populateFilterOptions(roleplays) {
  const select = document.getElementById('filter-student');
  const studentsSet = new Set();

  roleplays.forEach(r => {
    studentsSet.add(r.comprador);
    studentsSet.add(r.vendedor);
  });

  // Clear options except "All"
  while (select.options.length > 1) {
    select.remove(1);
  }

  studentsSet.forEach(student => {
    const option = document.createElement('option');
    option.value = student;
    option.textContent = student;
    select.appendChild(option);
  });
}

function renderTable(filteredRoleplays) {
  const tbody = document.querySelector("#roleplays-table tbody");
  tbody.innerHTML = "";

  filteredRoleplays.forEach(r => {
    const totalCost = r.costes.reduce((a, b) => a + b, 0).toFixed(2);
    const productosHTML = r.productos.join(", ");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.comprador}</td>
      <td>${r.vendedor}</td>
      <td>${productosHTML}</td>
      <td>â‚¬${totalCost}</td>
      <td><audio controls src="${r.audio_url}"></audio></td>
      <td>${new Date(r.timestamp).toLocaleString()}</td>
    `;
    tbody.appendChild(tr);
  });
}

function loadRoleplays() {
  fetch('/roleplays')
    .then(response => response.json())
    .then(data => {
      allRoleplays = data;
      populateFilterOptions(allRoleplays);
      renderTable(allRoleplays);
    })
    .catch(() => alert('Failed to load roleplays'));
}

document.getElementById('filter-student').addEventListener('change', (e) => {
  const selected = e.target.value;
  if (selected === 'all') {
    renderTable(allRoleplays);
  } else {
    const filtered = allRoleplays.filter(r => r.comprador === selected || r.vendedor === selected);
    renderTable(filtered);
  }
});

document.getElementById('refresh-roleplays').addEventListener('click', loadRoleplays);

// Form submission to upload roleplay
document.getElementById('roleplay-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);

  // Convert comma separated to JSON strings for products and costs
  formData.set('productos', JSON.stringify(formData.get('productos').split(',').map(p => p.trim())));
  formData.set('costes', JSON.stringify(formData.get('costes').split(',').map(c => parseFloat(c.trim()) || 0)));

  try {
    const res = await fetch('/upload', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    if (data.status === 'ok') {
      alert('Roleplay uploaded successfully!');
      form.reset();
      loadRoleplays();
    } else {
      alert('Failed to upload roleplay');
    }
  } catch {
    alert('Error uploading roleplay');
  }
});

// Uploads history
document.getElementById('refresh-uploads').addEventListener('click', () => {
  fetch('/uploads')
    .then(res => res.json())
    .then(files => {
      const ul = document.getElementById('uploads-list');
      ul.innerHTML = "";
      if (files.length === 0) {
        ul.innerHTML = "<li>No uploads found</li>";
        return;
      }
      files.forEach(f => {
        const li = document.createElement('li');
        li.textContent = `${f.filename} - ${new Date(f.timestamp).toLocaleString()}`;
        ul.appendChild(li);
      });
    })
    .catch(() => {
      alert("Failed to load uploads.");
    });
});

// Initial load
window.onload = () => {
  loadRoleplays();
  document.getElementById('refresh-uploads').click();
};
</script>

</body>
</html>
