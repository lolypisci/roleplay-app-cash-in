<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Rolefy – Teacher View</title>
  <link rel="icon" href="icon.ico"/>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; background:#f4f6f8; color:#333; }
    header { display:flex; align-items:center; gap:10px; }
    header img { height:40px; }
    header h1 { margin:0; font-size:1.8rem; }
    .tabs { margin-top:20px; }
    .tabs button { padding:10px 20px; margin-right:5px; border:none; background:#ddd; cursor:pointer; }
    .tabs button.active { background:#2980b9; color:#fff;}
    .tab-content { margin-top:20px; }
    table { width:100%; border-collapse:collapse; background:#fff; box-shadow:0 0 5px rgba(0,0,0,0.1);}
    th,td{padding:8px;border:1px solid #e0e0e0;text-align:left;}
    th {background:#2980b9;color:#fff;}
    td.editable:hover {background:#f0f8ff;cursor:pointer;}
    button.primary { background:#2980b9;color:white;border:none;padding:8px 12px;border-radius:3px;cursor:pointer;}
    button.primary:hover { background:#1f6391; }
    form label{display:block;margin-top:10px;}
    form input, form textarea{width:100%;padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:3px;}
  </style>
</head>
<body>
<header>
  <img src="logo.png" alt="Rolefy Logo"/>
  <h1>Rolefy – Teacher View</h1>
</header>

<div class="tabs">
  <button id="tab-sessions" class="active">Saved Sessions</button>
  <button id="tab-record">Record Roleplay</button>
</div>

<div id="content-sessions" class="tab-content">
  <div style="margin-bottom:10px;">
    <label>Filter by Student:
      <select id="filter-student"><option value="all">All</option></select>
    </label>
    <button id="refresh-roleplays" class="primary">Refresh</button>
    <button id="btn-backup" class="primary">Create Backup</button>
    <button id="btn-restart" class="primary">Restart Railway</button>
  </div>
  <table>
    <thead>
      <tr><th>Buyer</th><th>Seller</th><th>Items</th><th>Total (€)</th>
          <th>Audio</th><th>Feedback</th><th>Score</th><th>Timestamp</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="content-record" class="tab-content" style="display:none;">
  <form id="roleplay-form">
    <label>Buyer Name:<input type="text" name="comprador" required></label>
    <label>Seller Name:<input type="text" name="vendedor" required></label>
    <label>Products (comma separated):<input type="text" name="productos" required></label>
    <label>Costs (comma separated):<input type="text" name="costes" required></label>
    <label>Audio File:<input type="file" name="audio" accept="audio/*" required></label>
    <button type="submit" class="primary">Submit Roleplay</button>
  </form>
</div>

<script>
let allRoleplays = [];
// Tabs
document.getElementById('tab-sessions').onclick = () => {
  document.getElementById('content-sessions').style.display = '';
  document.getElementById('content-record').style.display = 'none';
  tabActive('sessions');
};
document.getElementById('tab-record').onclick = () => {
  document.getElementById('content-sessions').style.display = 'none';
  document.getElementById('content-record').style.display = '';
  tabActive('record');
};
function tabActive(id){
  document.getElementById('tab-sessions').classList.toggle('active', id==='sessions');
  document.getElementById('tab-record').classList.toggle('active', id==='record');
}

// Load & render
async function loadRoleplays(){
  allRoleplays = await fetch('/roleplays').then(r=>r.json());
  populateFilterOptions(); renderTable(allRoleplays);
}
function populateFilterOptions(){
  const sel = document.getElementById('filter-student');
  const set = new Set();
  allRoleplays.forEach(r=>{ set.add(r.comprador); set.add(r.vendedor); });
  sel.innerHTML = '<option value="all">All</option>';
  set.forEach(s=> sel.innerHTML += `<option value="${s}">${s}</option>`);
}
function renderTable(data){
  const tbody = document.querySelector('tbody'); tbody.innerHTML = '';
  data.forEach(r=>{
    const total = r.costes.reduce((a,b)=>a+b,0).toFixed(2);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.comprador}</td>
      <td>${r.vendedor}</td>
      <td>${r.productos.join(', ')}</td>
      <td>€${total}</td>
      <td><audio controls src="${r.audio_url}"></audio></td>
      <td class="editable" data-id="${r.id}" data-field="feedback">${r.feedback}</td>
      <td class="editable" data-id="${r.id}" data-field="score">${r.score}</td>
      <td>${new Date(r.timestamp).toLocaleString()}</td>
    `;
    tbody.appendChild(tr);
  });
  makeEditable();
}

// Inline editing
function makeEditable(){
  document.querySelectorAll('.editable').forEach(td=>{
    td.onclick = async ()=>{
      const old = td.textContent;
      const input = document.createElement(td.dataset.field==='score'?'input':'textarea');
      input.value = old;
      td.innerHTML = ''; td.appendChild(input);
      input.focus();
      input.onblur = async ()=>{
        const val = input.value;
        await fetch(`/roleplays/${td.dataset.id}/feedback`, {
          method:'PATCH',
          body: new URLSearchParams({ [td.dataset.field]:val })
        });
        td.textContent = val;
      };
    };
  });
}

// Filter
document.getElementById('filter-student').onchange = e=>{
  const v = e.target.value;
  renderTable(v==='all'?allRoleplays:allRoleplays.filter(r=>r.comprador===v||r.vendedor===v));
};

// Buttons
document.getElementById('refresh-roleplays').onclick = loadRoleplays;
document.getElementById('btn-backup').onclick = ()=>
  window.open('/backup','_blank');
document.getElementById('btn-restart').onclick = async ()=>{
  const res = await fetch('/restart_railway',{method:'POST'});
  alert((await res.json()).status==='restarted'?'Railway restarted!':'Error');
};

// Form submit
document.getElementById('roleplay-form').onsubmit = async e=>{
  e.preventDefault();
  const f = new FormData(e.target);
  f.set('productos', JSON.stringify(f.get('productos').split(',').map(s=>s.trim())));
  f.set('costes', JSON.stringify(f.get('costes').split(',').map(s=>parseFloat(s)||0)));
  const r = await fetch('/upload',{method:'POST',body:f});
  if((await r.json()).status==='ok'){
    alert('Uploaded!');
    e.target.reset(); loadRoleplays();
  } else alert('Error');
};

// Init
window.onload = ()=>{ loadRoleplays(); };
</script>
</body>
</html>
